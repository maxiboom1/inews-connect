<!DOCTYPE html>
<html>
<head>
 <meta http-equiv="X-UA-Compatible" content="IE=edge" />
 <meta charset="utf-8" />
 <title>iNEWS HTML5 Browser Plugin Sample</title>
 <script type="text/javascript">	

	function finalMsg(){

		var group = document.getElementById("group").value;
		var gfxItem = document.getElementById("gfxItem").value;
		var payload = document.getElementById("payload").value;

		var finalMsg = 
		`<mos>
			<ncsItem>
				<item>
					<itemID>0</itemID>
					<itemSlug>${payload}</itemSlug>
					<objID>12345</objID>
					<mosID>iNEWSMOS1</mosID>
					<mosItemBrowserProgID>alex</mosItemBrowserProgID>
					<mosItemEditorProgID>alexE</mosItemEditorProgID>
					<mosAbstract>${payload}</mosAbstract>
					<group>${group}</group>
					<gfxItem>${gfxItem}</gfxItem>
				</item>
			</ncsItem>
		</mos>`;
		sendToGfxServer(`<msg>finalmsg: ${payload}</msg>`);
		return finalMsg;
	}

	function startObjectDrag(event) {
		event.dataTransfer.setData("text", finalMsg("0"));
		event.dataTransfer.effectAllowed = "copyMove";
		event.dataTransfer.dropEffect = "copy";
		sendToGfxServer("<msg>start</msg>");
		}
	function endObjectDrag(event) {
		console.log(event)
		sendToGfxServer("<msg>end</msg>");
		}

	function getNewsroomOrigin() {
		var qs = document.location.search.split("+").join(" ");
		var params = {};
		var regex = /[?&]?([^=]+)=([^&]*)/g;
		while (tokens = regex.exec(qs)) {
			params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
		}
		return params['origin'];
	}
	
	function mosMsgFromPlugIn(message) {
		sendToGfxServer("<msg>mosMsgFromPlugIn</msg>");
		window.parent.postMessage(message, getNewsroomOrigin());
	}
	
	function mosMsgFromHost(event) {
		console.log(event.data);
		var message = event.data;
		sendToGfxServer(message);
		//----------------Message parser (Alex)
		if (message !== "<mos><ncsItemRequest/></mos>"){
			var payload1 = message.slice(message.indexOf("itemSlug>")+9, message.indexOf("</itemSlug>"));
			var group1 = message.slice(message.indexOf("group>")+6, message.indexOf("</group>"));
			var gfxItem1 = message.slice(message.indexOf("gfxItem>")+8, message.indexOf("</gfxItem>"));
			document.getElementById("payload").value = payload1;
			document.getElementById("group").value = group1;
			document.getElementById("gfxItem").value = gfxItem1;
		} else {
			//sendToGfxServer('<msg>APPLY/SAVE</msg>');// HERE USER ARE CLICK "APPLY"/"OK"
		}

		if (event.origin != getNewsroomOrigin()) {return;}
		
		if (message.indexOf('<ncsAck>') === -1){
			//event.source.postMessage("<mos><ncsAck><status>ACK</status></ncsAck></mos>", event.origin);
		}
		
		if (message.indexOf('<ncsItemRequest>') === -1){event.source.postMessage(finalMsg(), event.origin);}

	}

	function sendToGfxServer(msg){
		console.log('data to post: ', msg);
		var url = 'http://localhost:3000/api/plugin'; // Replace with your API URL
		fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'text/plain', // Adjust content type as needed
			},
			body: msg,
		})
		.then(response => {
			if (response.ok) {
				console.log('Data posted successfully');
			} else {
				console.error('Failed to post data');
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});
	}

	if (window.addEventListener) {
		sendToGfxServer("<msg>USER OPENED GFX IN NCS</msg>");
		window.addEventListener('message', mosMsgFromHost, false);
	} else if (window.attachEvent) {
		sendToGfxServer("<msg>2</msg>");
		window.attachEvent('onmessage', mosMsgFromHost, false);
	}
</script>
<style>
	body {background-color:Blue}
	div {color:Black}
	input.mosInput {
	width:200px; height:25px;
	}
</style>
</head>
<body height="50%" >
	
	<!-- GROUP MENU -->
	<h1> DEMO HTML PLUGIN FOT INEWS - V.001</h1>
	<div style="width:500px;height:30px;overflow:auto;backgroundcolor:gray" contenteditable="true">
		<label for="menu1">Choose category:</label>
		<select onchange="setGfxItems()" name="group" id="group">
			<option value="1">סצנה-1</option>
			<option value="2">סצנה-2</option>	
		  </select>
	</div> 
	<!-- GFX ITEM MENU + PAYLOAD -->
	<div style="width:500px;height:200px;overflow:auto;backgroundcolor:gray" contenteditable="true" id="gfxItemDiv">
		<label for="menu2">Choose an item:</label>
		<select  name="gfxItem" id="gfxItem">
			<option value="1">סטרייפ</option>
			<option value="2">סופר</option>	
		  </select>
		  <br><br><br>
		<label for="name">Text data:</label>
		<input type="text" id="payload" ><br><br><br>
		<img id="drag1" src="drag.png" draggable="true" ondragstart="startObjectDrag(event)" ondragend="endObjectDrag(event)"  alt="☑" width="30" height="30">

	</div> 

</body>
</html>